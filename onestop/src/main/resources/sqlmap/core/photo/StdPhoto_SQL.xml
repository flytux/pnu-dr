<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 
     * 학생사진관리(BLOB) MyBatis SqlMap으로서 작용한다.
     * @Company : IDINO Co., Ltd.
     * @Copyright : Copyright (C) by IDINO All rights reserved.
     * @Author : 김홍집
     * @Create : 2020-07-15
     * @Title : entr.enpr.entrhschprmngt
     * @version 1.0
     * @stereotype Sql
-->
<mapper namespace="core.photo.stdphoto">

    <resultMap type="hashMap" id="selectOneBlobMap">
        <result property="PHT" column="PHT" jdbcType="BLOB"></result>
    </resultMap>
    <select id="selectOneStdPhoto"  parameterType="map" resultMap="selectOneBlobMap">
    /* comm.photo.stdphoto.selectOneStdPhoto (원서접수관리 원서관리 학생 사진 조회)        */
        SELECT PHT FROM ENTR410 WHERE YY = #{YY} AND RES_NO = F_ENCRYPT(#{RES_NO})
    </select>

    <parameterMap id="saveStdPhotoMap" type="java.util.Map">
        <parameter property="YY"                mode="IN"   jdbcType="VARCHAR" />
        <parameter property="RES_NO"             mode="IN"   jdbcType="VARCHAR" />
        <parameter property="PHT"               mode="IN"   jdbcType="BLOB" />
        <parameter property="FILE_NM"         mode="IN"   jdbcType="VARCHAR" />
                
        <parameter property="MOD_USER_ID"       mode="IN"   jdbcType="VARCHAR" />
        <parameter property="MOD_PRG_ID"        mode="IN"   jdbcType="VARCHAR" />
        <parameter property="MOD_USER_IP"       mode="IN"   jdbcType="VARCHAR" />
        <parameter property="O_RSLT"            mode="OUT"  jdbcType="VARCHAR" />
        <parameter property="O_MSG"             mode="OUT"  jdbcType="VARCHAR" />
        <parameter property="O_KEY"             mode="OUT"  jdbcType="VARCHAR" />
    </parameterMap>  
    
    <select id="saveStdPhoto" statementType="CALLABLE" parameterMap="saveStdPhotoMap">
    /* comm.photo.stdphoto.saveStdPhoto (원서접수관리 원서관리 학생 사진 BLOB 저장)        */
            { CALL USP_STDPHOTO_SAVE(?,?,?,?,
                                     ?,?,?,?,?,?) }
    </select>
    
    <parameterMap id="deleteStdPhotoMap" type="java.util.Map">
        <parameter property="YY"                mode="IN"   jdbcType="VARCHAR" />
        <parameter property="RES_NO"             mode="IN"   jdbcType="VARCHAR" />
                
        <parameter property="MOD_USER_ID"       mode="IN"   jdbcType="VARCHAR" />
        <parameter property="MOD_PRG_ID"        mode="IN"   jdbcType="VARCHAR" />
        <parameter property="MOD_USER_IP"       mode="IN"   jdbcType="VARCHAR" />
        <parameter property="O_RSLT"            mode="OUT"  jdbcType="VARCHAR" />
        <parameter property="O_MSG"             mode="OUT"  jdbcType="VARCHAR" />
        <parameter property="O_KEY"             mode="OUT"  jdbcType="VARCHAR" />
    </parameterMap>  
    
    <select id="deleteStdPhoto" statementType="CALLABLE" parameterMap="deleteStdPhotoMap">
    /* comm.photo.stdphoto.deleteStdPhoto (원서접수관리 원서관리 학생 사진 BLOB 삭제)        */
            { CALL USP_STDPHOTO_DEL(?,?,
                                     ?,?,?,?,?,?) }
    </select>

    <select id="selectOneDisplaySregPhoto"  parameterType="map" resultType="hashmap">
    /* comm.photo.stdphoto.selectOneDisplaySregPhoto (학생사진 조회)        */
      <choose>
      
        <when test='GUBUN != null and "170".equals(GUBUN)'>
                SELECT PHT 
                FROM (SELECT PHT ,RANK() OVER(PARTITION BY STD_NO ORDER BY APLY_DTTM DESC) RNK 
                      FROM   SREG170 
                      WHERE  STD_NO = #{STD_NO}) 
                WHERE RNK   = 1      
        </when>
        
        <otherwise>
            SELECT PHT FROM SREG160 WHERE STD_NO = #{STD_NO}
        </otherwise>
        
      </choose>
    </select>
    
    <select id="selectOneDisplaySregPhoto2"  parameterType="map" resultType="hashmap">
    /* comm.photo.stdphoto.selectOneDisplaySregPhoto2 (학생사진신청 조회)        */
        SELECT PHT 
        FROM   SREG170 
        WHERE  STD_NO = #{STD_NO} 
        AND    TO_CHAR(APLY_DTTM, 'YYYYMMDDHH24MISS') = #{APLY_DTTM}       
    </select>
    
    <parameterMap id="saveSregStdPhotoMap" type="java.util.Map">
        <parameter property="STD_NO"                mode="IN"   jdbcType="VARCHAR" />
        <parameter property="PHT"               mode="IN"   jdbcType="BLOB" />
        <parameter property="FILE_NM"         mode="IN"   jdbcType="VARCHAR" />
                
        <parameter property="MOD_USER_ID"       mode="IN"   jdbcType="VARCHAR" />
        <parameter property="MOD_PRG_ID"        mode="IN"   jdbcType="VARCHAR" />
        <parameter property="MOD_USER_IP"       mode="IN"   jdbcType="VARCHAR" />
        <parameter property="O_RSLT"            mode="OUT"  jdbcType="VARCHAR" />
        <parameter property="O_MSG"             mode="OUT"  jdbcType="VARCHAR" />
        <parameter property="O_KEY"             mode="OUT"  jdbcType="VARCHAR" />
    </parameterMap>  
    
    <select id="saveSregStdPhoto" statementType="CALLABLE" parameterMap="saveSregStdPhotoMap">
    /* comm.photo.stdphoto.saveSregStdPhoto (학생사진신청 BLOB 저장)        */
            { CALL USP_SREGSTDPHOTO_SAVE(?,?,? ,?,?,? ,?,?,?) }
    </select>
    
</mapper>
