<div id="popups">
	<section class="sec-1">
		<div class="sec-body">
			<input type="hidden" id="SYEAR">
			<input type="hidden" id="TERM_GCD">
			<input type="hidden" id="STDT_NO">
			<input type="hidden" id="rowStatus">
			<div class="b-table-box flex-col-3" id="stdtTable" role="table" aria-label="학적정보 테이블">
				<div class="b-row-box" role="row">
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label data-lang>대학(원)</label>
						</div>
						<div class="b-con-box" role="cell" data-bind="text: GRAD_GCD_NM"></div>
					</div>
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label data-lang>학위</label>
						</div>
						<div class="b-con-box" role="cell" data-bind="text: DEG_COURSE_GCD"></div>
					</div>
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label data-lang>학과(부)</label>
						</div>
						<div class="b-con-box" role="cell" data-bind="text: DEPT_CD_NM"></div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label data-lang>학번</label>
						</div>
						<div class="b-con-box" role="cell" data-bind="text: STDT_NO"></div>
					</div>
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label data-lang>학년</label>
						</div>
						<div class="b-con-box" role="cell" data-bind="text: STDT_YEAR_GCD"></div>
					</div>
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label data-lang>성명</label>
						</div>
						<div class="b-con-box" role="cell" data-bind="text: STDT_KOR_NM"></div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label data-lang>연락처</label>
						</div>
						<div class="b-con-box" role="cell" data-bind="text: STDT_CELLULAR_NO"></div>
					</div>
					<div class="b-row-item merge-2">
						<div class="b-title-box" role="rowheader"></div>
						<div class="b-con-box" role="cell">
							<label data-lang>※ 연락처가 변경된 경우 [학적-개인정보수정]에서 변경</label>
						</div>
					</div>
				</div>
			</div>

			<!-- 국문 시작 -->
			<div class="card">
				<div class="mb-2 text-center">
					<strong> 분할납부 신청 안내<br /> (Notice of Application for Payment in installments)
					</strong>
				</div>

				<ol class="ol-style-single mt-1">
					<li class="text-left">분할납부 1회차를 정해진 기간 내에 납부하지 않으면 자동으로 분할납부 신청이 취소됨<br /> (If the first installment payment of tuition is not paid within the specified period, the installment payment will be automatically canceled)
					</li>
					<li class="text-left">분할납부 1회차를 납부하게 되면 분할납부 취소 불가<br /> (Cancellation of installment payment is unavailable if the first amount of installment is paid)
					</li>
					<li class="text-left">분할납부자가 휴학 및 자퇴를 원할 경우 등록금을 완납하여야 함<br /> (If the application of installment payment wishes for a leave of absence or drop out of school, the full amount of tuition must be paid)
					</li>
					<li class="text-left">분할 납부금 중 미납액이 있을 경우 미등록 제적처리 됨<br /> (If there are some unpaid amount for installment payment, you will be expelled)
					</li>
					<li class="text-left">납부기간 내에 납부하지 않을 경우 다음 학기 분할납부 신청에 제한을 받을 수 있음<br /> (Failure to pay within the payment period may result in restrictions on applications for installment payment for the next semester)
					</li>
				</ol>
				<p class="mt-2 mb-2">
					<strong> ※ 안내사항에 대한 동의를 거부할 수 있습니다. 다만, 동의를 거부할 경우 분할납부 신청이 불가합니다.<br /> (You can refuse to accept the instructions. However, if you refuse to agree, you cannot apply for payment in installments.)
					</strong>
				</p>
				<div class="text-center">
					<label for="agree1"><span class="dfn mr-2">동의함(agree)</span></label>
					<input type="radio" id="agree1" name="agree1" value="Y" onclick="fn_agreeChk();" />&nbsp;&nbsp; 
					<label for="agree2"><span class="dfn mr-2">미동의(disagree)</span></label>
					<input type="radio" id="agree2" name="agree1" value="N" onclick="fn_agreeChk();" />
				</div>
			</div>
			<!-- 국문 끝 -->

			<label class="mb-1 mt-1">※ 분할 1 · 4차는 학자금대출이 불가 하오니 착오없으시기 바랍니다.(학생과 051-510-1272)</label>

			<div class="card">
				<div class="card-header" id="">
					<strong>[분할 납부신청서 작성]</strong>
				</div>
				<div class="sec-body">
					<ul class="list list-style-1">
						<li class="text-primary">분할등록 신청은 2~4회까지 신청 가능합니다.</li>
						<li class="text-primary">단, 1회차는 25%이상이여야 하며 한번에 5%씩 조정이 가능합니다.</li>
					</ul>

					<div class="b-table-box flex-col-2" id="" role="table" aria-label="분할납부">
						<div class="b-row-box" role="row">
							<div class="b-row-item merge-2">
								<div class="b-title-box" role="rowheader">
									<label data-lang>분할납부<br>신청학기
									</label>
								</div>
								<div class="b-con-box" role="cell">
									<label type="hidden" id="lblYearTerm" data-bind="" /> 
								</div>
							</div>
						</div>
						<div class="b-row-box" role="row">
							<div class="b-row-item ">
								<div class="b-title-box" role="rowheader">
									<label for="DEVIDE_TIMESNO" data-lang>분할횟수</label>
								</div>
								<div class="b-con-box" role="cell">
									<select id="DEVIDE_TIMESNO" class="form-control" onchange="fn_onchange()"></select>
								</div>
							</div>
							<div class="b-row-item ">
								<div class="b-title-box" role="rowheader">
									<label data-lang>총액</label>
								</div>
								<div class="b-con-box" role="cell">
									<label type="text" id="TOTAL_AMT" data-bind="" /> 
								</div>
							</div>
						</div>
					</div>

					<!-- 테이블 -->
					<div class="table-box table-list" style = "height:350px"> 
						<div class="table-body">
							<table class="table table-hover" data-toggle="table" data-show-column="true" >
								<caption>분할납부정보</caption>
								<colgroup>
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
								</colgroup>
								<thead>
									<tr>
										<th scope="col">분할횟수</th>
										<th scope="col">분할비율(%)</th>
										<th scope="col">수업료I(원)</th>
										<th scope="col">수업료II(원)</th>
										<th scope="col">납부기간</th>
									</tr>
								</thead>
								<tbody id="resultTbody">
							</table>
						</div>
					</div>
					<!-- /END 테이블 -->
				</div>
			</div>
	</section>
	<div class="_footer">
		<section class="sec-1">
			<div class="sec-body">
				<div class="btn-box">
					<div class="form-row btn-box-right">
						<div class="col-auto">
							<button class="btn btn-primary" id="btnInput" type="button" data-lang onclick="javascript:return fn_inputChk();">신청하기</button>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>
</div>

<script type="text/x-tbody-template" id="resultTemplate">

</script>

<script type="text/javascript">
	$(document).ready(popInit());
	var dataCnt = 0;
	var rowNum = 0;
	
	var rowNo = new Array();
	var rowList = new Array();
	
	var divideCnt = 0;
	
	function popInit() {
		$('#STDT_NO').val(scwin.loginUser.userId);
		fn_enYearTerm();
		
		/*
		$('#SYEAR').val('2023');
		$('#TERM_GCD').val('0010');
		
		if($('#TERM_GCD').val()=="0010"){
			var termNm = "1학기";
		}else {
			var termNm = "2학기";
		}
		
		$('#lblYearTerm').text($('#SYEAR').val() + "년 " + termNm);
		*/
		
		gfn_com_DropDownLists([ {
			elements : $("#DEVIDE_TIMESNO"),
			commonCode : "0001_ENROLL_ETC_GCD",
			dataTextField : "COMMON_DETAIL_CD_KOR_NM",
			dataValueField : "COMMON_DETAIL_CD",
			optionLabel : "선택",
			optionValue : "",
			defaultValue : "",
			expnCondition : "AND CHAR_1_CONTENT LIKE'%07%'",
			hakbuGradFg : false,
			dataBound : function(e) {
			}
		} ]);
		
		
		$("#btnInput").hide();
		
		
		$("input[name='DEVIDE_RATIO']").change(function() {
			fn_onchangeRatio(); //비율계산	
		});
		
	}
	
	function fn_enYearTerm(){
		var param = {};
		gfn_ajax_request({
			url : "/ost/enroll/enrollamtpayguide/devidepay/selectEnYearTerm",
			reqData : param,
			success : function(data, responseData) {
				$('#SYEAR').val(data.SYEAR);
				$('#TERM_GCD').val(data.TERM_GCD);
				
				if($('#TERM_GCD').val()=="0010"){
					var termNm = "1학기";
				}else {
					var termNm = "2학기";
				}
				
				$('#lblYearTerm').text($('#SYEAR').val() + "년 " + termNm);
				
				setInit();

			}
		});
		
	}

	/*  팝업창 로드 시 초기설정 함수 */
	function setInit() {
		fn_applyList();  	//신청내역 조회
		fn_stdtInfo();		//기본 정보 조회
	}
	
	
	/* 동의 체크 */
	function fn_agreeChk(){
		if($("#agree1").is(":checked") == true){
			$("#btnInput").show();	
		}else if($("#agree2").is(":checked") == true) {
			$("#btnInput").hide();
		}
	}
	
	/***************************************************************************
	 * fn_onchange  -- select 값 변할때
	 **************************************************************************/
	function fn_onchange() {
		divideCnt = parseInt($("#DEVIDE_TIMESNO").val().substr(3,1));

		if(divideCnt=="2"){
			$("#resultTbody tr:eq(0)").find(".DEVIDE_RATIO").val(50);
			$("#resultTbody tr:eq(1)").find(".DEVIDE_RATIO").val(50);
			$("#resultTbody tr:eq(2)").find(".DEVIDE_RATIO").val(0);
			$("#resultTbody tr:eq(3)").find(".DEVIDE_RATIO").val(0);
			$("#row1").show();
			$("#row2").show();
			$("#row3").hide();
			$("#row4").hide();
		} else if(divideCnt=="3"){
			$("#resultTbody tr:eq(0)").find(".DEVIDE_RATIO").val(35);
			$("#resultTbody tr:eq(1)").find(".DEVIDE_RATIO").val(35);
			$("#resultTbody tr:eq(2)").find(".DEVIDE_RATIO").val(30);
			$("#resultTbody tr:eq(3)").find(".DEVIDE_RATIO").val(0);
			$("#row1").show();
			$("#row2").show();
			$("#row3").show();
			$("#row4").hide();
		} if(divideCnt=="4"){
			$("#resultTbody tr:eq(0)").find(".DEVIDE_RATIO").val(25);
			$("#resultTbody tr:eq(1)").find(".DEVIDE_RATIO").val(25);
			$("#resultTbody tr:eq(2)").find(".DEVIDE_RATIO").val(25);
			$("#resultTbody tr:eq(3)").find(".DEVIDE_RATIO").val(25);
			$("#row1").show();
			$("#row2").show();
			$("#row3").show();
			$("#row4").show();
		}
			
		
		fn_onchangeRatio(); //비율계산	

	}
	var ratioSum = 0; //비율 총합계
	var ratio = 0 ; //비율
	/***************************************************************************
	 * fn_onchangeRatio  -- 분할비율  => 분할횟수가 바뀌거나 비율이 바뀔때 타야함
	 **************************************************************************/
	function fn_onchangeRatio() {
		
		var strAmt1 = "" //금액
 		var priceChk1 = 0; //천원단위
		var priceAll1 = 0;  // 천원 절삭
		var firstPrice1 = 0;
		var price1 = 0;
		
		var strAmt2 = "" //금액
	 	var priceChk2 = 0; //천원단위
		var priceAll2 = 0;  // 천원 절삭
		var firstPrice2 = 0;
		var price2 = 0;

		divideCnt = parseInt($("#DEVIDE_TIMESNO").val().substr(3,1));
		
	 	for (var i = 0; i < 4; i++) {
	 		
			ratio = parseInt($("#resultTbody tr:eq(" + i + ")").find(".DEVIDE_RATIO").val());
			if (ratio == 0){
				
				$('#resultTbody tr:eq(' + i + ') td:eq(2)').text(0);
				$('#resultTbody tr:eq(' + i + ') td:eq(3)').text(0);
			}
		}  
		  
		for (var i = 0; i < divideCnt; i++) {
			ratio = parseInt($("#resultTbody tr:eq(" + i + ")").find(".DEVIDE_RATIO").val());  // 분할횟수에 따른 분할비율
			
			intAmt1 = Amt1 * ratio / 100;  // 총액에서 분할비율에 따른 값
			strAmt1 = String(Amt1 * ratio / 100);
			
			intAmt2 = Amt2 * ratio / 100;  // 총액에서 분할비율에 따른 값
			strAmt2 = String(Amt2 * ratio / 100);
			
			if(strAmt1 != "0" && i != 0) {
				priceChk1 = parseInt(strAmt1.substr(-4));  //천원단위가져오기
				priceAll1 = priceAll1+ priceChk1;  //천원 절삭한 모든 값
				
				$('#resultTbody tr:eq(' + i + ') td:eq(2)').text(String(intAmt1-priceChk1).toString().replaceAll(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","));
			}
			else{
				$('#resultTbody tr:eq(' + i + ') td:eq(2)').text(strAmt1.toString().replaceAll(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","));
			}
			
			if(strAmt2 != "0" && i != 0) {
				priceChk2 = parseInt(strAmt2.substr(-4));  //천원단위가져오기
				priceAll2 = priceAll2+ priceChk2;  //천원 절삭한 모든 값
				
				$('#resultTbody tr:eq(' + i + ') td:eq(3)').text(String(intAmt2-priceChk2).toString().replaceAll(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","));
			}
			else{
				$('#resultTbody tr:eq(' + i + ') td:eq(3)').text(strAmt2.toString().replaceAll(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","));
				
			}
		} 
		
		firstPrice1 = parseInt($('#resultTbody tr:eq(0) td:eq(2)').text().replaceAll(",",""));
		firstPrice2 = parseInt($('#resultTbody tr:eq(0) td:eq(3)').text().replaceAll(",",""));
		
		
		$('#resultTbody tr:eq(0) td:eq(2)').text(String(firstPrice1 + priceAll1).toString().replaceAll(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","));  //절삭된 모든값은 1회차에 저장
		$('#resultTbody tr:eq(0) td:eq(3)').text(String(firstPrice2 + priceAll2).toString().replaceAll(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","));  //절삭된 모든값은 1회차에 저장
		
	}
	
	var Amt = 0;
	var Amt1 = 0;
	var Amt2 = 0;	
	/* 신청내역 조회 */
	function fn_applyList() {
		var param = gfn_com_inputdata($("#popups"));
		param.GBN = "2";
		gfn_ajax_request({
			url : "/ost/enroll/enrollamtpayguide/devidepay/selectApplyList",
			reqData : param,
			success : function(data, responseData) {
				dataCnt = data.length;
				var len = JSON.stringify(data.length);
				for (var i = 0; i < len; i++) {
					if(data[i].RN != "") {
						var no = data[i].RN;
						var num = i;
						rowNo.push(num);
					}
				}        
								
				Amt1 = (data.length >0 )?data[0].TOTAL_CLASS_1_AMT :0;
				Amt2 = (data.length >0 )?data[0].TOTAL_CLASS_2_AMT :0;
				Amt = (data.length >0 )?data[0].TOTAL_AMT :0;
				
				var totalAmt = Amt.toString().replaceAll(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");  //숫자콤마
				var totalAmt1 = Amt1.toString().replaceAll(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
				var totalAmt2 = Amt2.toString().replaceAll(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");				

				$('#TOTAL_AMT').text(totalAmt); 
				if(data.length > 0){
					$('#DEVIDE_TIMESNO').val("070"+data[0].DEVIDE_TIMESNO); 
				}
				
				if(data.length < 1) {   
					$('#rowStatus').val("C");
	   		    }else{
	   		    	$('#rowStatus').val("U");
		    		$('#agree1').attr("disabled", "true");
		    		$('#agree2').attr("disabled", "true");		
		    		$('#agree1').attr("checked", "true");
		    		$("#btnInput").show();
	   		    } 

				$("#resultTbody").listView({
					dataSource : data,
					dataBound : function(e) {
						totalCnt = responseData.totCnt;
						//currentData = data;
					},
					template : $("#resultTemplate"),
		            totalViewYn : "N",
					paging : null,
					emptyComment : '데이터가 존재하지 않습니다.',
					excel : null
				});
				
				//$("#DEVIDE_AMT").text().toString().replaceAll(/\B(?=(\d{3})+(?!\d))/g, ",");
				
				//분할횟수 4만큼 미리 세팅
				for (i=0; i<4; i++){
					var html = "<tr id='row"+(i+1)+"' class=tableList " + i + "style='cursor:pointer;'>";
					if(i==0){
						html += "<td>"+(i+1)+"</td>";
						html += "<td><input type='number' id='DEVIDE_RATIO' name='DEVIDE_RATIO' class='form-control DEVIDE_RATIO' onchange='fn_onchangeRatio()' style='text-align: center' value='' min='25' max='100' step='5' title='분할비율'></input></td>";
						html += "<td class='text-right'></td>";
						html += "<td class='text-right'></td>";
						html += "<td></td>";
						html += "</tr>";
						$("#resultTbody").append(html);
					}
					else{
						html += "<td>"+(i+1)+"</td>";
						html += "<td><input type='number' id='DEVIDE_RATIO' name='DEVIDE_RATIO' class='form-control DEVIDE_RATIO' onchange='fn_onchangeRatio()' style='text-align: center' value='' min='0' max='100' step='5' title='분할비율'></input></td>";
						html += "<td class='text-right'></td>";
						html += "<td class='text-right'></td>";
						html += "<td></td>";
						html += "</tr>";
						$("#resultTbody").append(html);
					}
				}
				
				$("#resultTbody tr:eq(0)").find(".DEVIDE_RATIO").val(25);
				$("#resultTbody tr:eq(1)").find(".DEVIDE_RATIO").val(25);
				$("#resultTbody tr:eq(2)").find(".DEVIDE_RATIO").val(25);
				$("#resultTbody tr:eq(3)").find(".DEVIDE_RATIO").val(25);
				/*
				if(data.length == 1){
					$('#resultTbody tr:eq(0) td:eq(4)').text(data[0].PAY_CLOSE_DATE);
				}else if(data.length == 2){
					$('#resultTbody tr:eq(1) td:eq(4)').text(data[1].PAY_CLOSE_DATE);
				}else if(data.length == 3){
					$('#resultTbody tr:eq(2) td:eq(4)').text(data[2].PAY_CLOSE_DATE);
				}else if(data.length == 4){
					$('#resultTbody tr:eq(3) td:eq(4)').text(data[3].PAY_CLOSE_DATE);
				}
				*/
				
				for(j=0; j<data.length; j++){
					$('#resultTbody tr:eq('+j+') td:eq(4)').text(data[j].PAY_CLOSE_DATE);
				}
				/*if(data.length > 0){
					if(data[0].DEVIDE_TIMESNO == "2"){
						$("#row3").hide();
						$("#row4").hide();
					}else if(data[0].DEVIDE_TIMESNO == "3"){
						$("#row3").show();
						$("#row4").hide();
					}else if(data[0].DEVIDE_TIMESNO == "4"){
						$("#row3").show();
						$("#row4").show();
					}
				}*/
				
				var appendHtml = "<tr style='cursor:pointer;'>";
				appendHtml += "<td>합</td>";
				appendHtml += "<td>100</td>";
				appendHtml += "<td class='text-right'>"+ totalAmt1 +"</td>";
				appendHtml += "<td class='text-right'>"+ totalAmt2 +"</td>";
				appendHtml += "<td></td>";
				appendHtml += "</tr>";
				$("#resultTbody").append(appendHtml);
				$("#resultTbody tr:last").css("background-color", "rgba(255, 255, 0, .080)");
				
				fn_onchangeRatio(); //비율계산
			}
		});
	}
	
	/* 기본정보 조회 */
	function fn_stdtInfo() {
		var searchParam = {
		};
		
		gfn_ajax_request({
			url : "/ost/enroll/enrollamtpayguide/devidepay/selectStdtInfo",
			reqData : searchParam,
			success : function(data, responseData) {
				
				gfn_com_dataBind($("#popups"), data);
			}
		});
		
	}

	/* 입력가능체크 */
	function fn_inputChk() {
		$('#rowStatus').val("C");
		ratioSum = 0;
		
		divideCnt = parseInt($("#DEVIDE_TIMESNO").val().substr(3,1));
		
		if($('#DEVIDE_TIMESNO').val()== ""){
			alert("분할 횟수를 선택하셔아 합니다.");
			return;
		} 
		
		for (var i = 0; i<divideCnt; i++) {
			ratioSum = ratioSum + parseInt($("#resultTbody tr:eq(" + i + ")").find(".DEVIDE_RATIO").val());
		}

		if(ratioSum>100 || ratioSum < 100) {
			alert("분할비율이 맞지 않습니다. (분할비율 : 100%)");
			ratioSum = 0;
			return;
		}
		
		var param = gfn_com_inputdata($("#popups"));
		
		gfn_ajax_request({
			url : "/ost/enroll/enrollamtpayguide/devidepay/selectInputChk",
			reqData : param,
			success : function(data, responseData) {
				if(data.MSGDLGTYPE == "OK"){
					fn_Update();
				}else{
					alert(data.MSG);
				}
			}
		});
		
	}
	
	/* 신청하기 */
	function fn_Update() {
		$('#rowStatus').val("C");
		
		var data = new Array();
		
		for (var i = 0; i<divideCnt; i++) {
			var map = gfn_com_inputdata($(".tableList"+rowNo[i]));
			data.push(map);
			
			data[i].SYEAR = $('#SYEAR').val();
			data[i].TERM_GCD = $('#TERM_GCD').val();
			data[i].DEVIDE_TIMESNO = $('#DEVIDE_TIMESNO').val();
			data[i].rowStatus = $('#rowStatus').val();
			data[i].CLAIM_DEVIDE_CHASU = i+1;
			data[i].DEVIDE_RATIO = $("#resultTbody tr:eq(" + i + ")").find(".DEVIDE_RATIO").val();
			data[i].DEVIDE_CLASS_1_AMT = $('#resultTbody tr:eq(' + i + ') td:eq(2)').text().replaceAll(",","");
			data[i].DEVIDE_CLASS_2_AMT = $('#resultTbody tr:eq(' + i + ') td:eq(3)').text().replaceAll(",","");
			
			
		}
		gfn_ajax_request({
			url : "/ost/enroll/enrollamtpayguide/devidepay/executeDevidePay",
	        reqData : data,
	        success : function(data, responseData) {
	        	alert('신청되었습니다.');
	        	
	        	gfn_com_closeModalWall(1,fn_chkTuition());  //팝업닫기
	        }
	    });  
	}
	
</script>