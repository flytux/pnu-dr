<div id="clausePopups">
	<section class="sec-1">
		<div class="sec-body">
			<section class="sec-2">				
				<div class="sec-body"></div>
			</section>
		</div>
	</section>
	<div class="_footer">
		<section class="sec-1">
			<div class="sec-body">
				<div class="btn-box">
					<div class="form-row btn-box-right">
						<div class="col-auto">
							<button class="btn btn-danger mb-2" onclick="javascript:return fn_clauseConfirm();" type="button">동의하기</button>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>
</div>
<script>
	$(document).ready(popInit());

	function popInit() {

		gfn_ajax_request({
			url : "/core/function/clauseDetailList",
			reqData : {
				SYSTEM_GCD : scwin.clause._options.systemGcd,
				CLAUSE_SEQ_NO : scwin.clause._options.clauseSeqNo
			},
			success : function(data, responseData) {
				$("#clausePopups .sec-2 .sec-body").html("");
				var innerHtml = '';
				$.each(data,function(i,v){
					innerHtml = '';
					innerHtml += '<div class="accordion mb-4">';
					innerHtml += '	<div class="card">';
					innerHtml += '		<div class="card-header" id="heading'+v.CLAUSE_DETAIL_SEQ_NO+'">';
					innerHtml += '			<button class="btn btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse'+v.CLAUSE_DETAIL_SEQ_NO+'" data-expanded="true" data-controls="collapse'+v.CLAUSE_DETAIL_SEQ_NO+'">'+((v.ESSENTIAL_FG == 'Y') ? '<span class="text-danger">[필수]</span> ' : '<span class="text-primary">[선택]</span> ')+v.CLAUSE_DETAIL_NM+'</button>';
					innerHtml += '		</div>';
					innerHtml += '		<div id="collapse'+v.CLAUSE_DETAIL_SEQ_NO+'" class="collapse show" aria-labelledby="heading'+v.CLAUSE_DETAIL_SEQ_NO+'">';
					innerHtml += '			<div class="card-body">';
					innerHtml += '				<ul class="nav nav-pills" role="tablist">';
					innerHtml += '					<li class="nav-item" role="presentation"><a class="nav-link active" id="tab'+v.CLAUSE_DETAIL_SEQ_NO+'_1" data-toggle="tab" href="#tab-cont'+v.CLAUSE_DETAIL_SEQ_NO+'_1" role="tab" data-selected="true" lang="K">국문</a></li>';
					if(gfn_str_parseNull(v.AGREE_ENG_CONTENT) != "") {
						innerHtml += '					<li class="nav-item" role="presentation"><a class="nav-link" id="tab'+v.CLAUSE_DETAIL_SEQ_NO+'_2" data-toggle="tab" href="#tab-cont'+v.CLAUSE_DETAIL_SEQ_NO+'_2" role="tab" data-selected="false" lang="E">영문</a></li>';
					}
					if(gfn_str_parseNull(v.AGREE_CHN_CONTENT) != "") {
						innerHtml += '					<li class="nav-item" role="presentation"><a class="nav-link" id="tab'+v.CLAUSE_DETAIL_SEQ_NO+'_3" data-toggle="tab" href="#tab-cont'+v.CLAUSE_DETAIL_SEQ_NO+'_3" role="tab" data-selected="false" lang="C">중문</a></li>';
					}
					innerHtml += '				</ul>';
					innerHtml += '				<div class="tab-content">';
					innerHtml += '					<div class="tab-pane fade show active" id="tab-cont'+v.CLAUSE_DETAIL_SEQ_NO+'_1" role="tabpanel" aria-labelledby="tab'+v.CLAUSE_DETAIL_SEQ_NO+'_1">'+gfn_com_htmlContent(v.AGREE_KOR_CONTENT)+'</div>';
					if(gfn_str_parseNull(v.AGREE_ENG_CONTENT) != "") {
						innerHtml += '					<div class="tab-pane fade" id="tab-cont'+v.CLAUSE_DETAIL_SEQ_NO+'_2" role="tabpanel" aria-labelledby="tab'+v.CLAUSE_DETAIL_SEQ_NO+'_2">'+gfn_com_htmlContent(v.AGREE_ENG_CONTENT)+'</div>';
					}
					if(gfn_str_parseNull(v.AGREE_CHN_CONTENT) != "") {
						innerHtml += '					<div class="tab-pane fade" id="tab-cont'+v.CLAUSE_DETAIL_SEQ_NO+'_3" role="tabpanel" aria-labelledby="tab'+v.CLAUSE_DETAIL_SEQ_NO+'_3">'+gfn_com_htmlContent(v.AGREE_CHN_CONTENT)+'</div>';
					}
					innerHtml += '				</div>';
					innerHtml += '			</div>';
					innerHtml += '		</div>';
					innerHtml += '	</div>';
					innerHtml += '</div>';
					if(gfn_str_parseNull(v.CLAUSE_KIND_GCD) == "0001") {
						innerHtml += '<section class="sec-3 mb-5" >';
						innerHtml += '	<div class="text-center">';
						innerHtml += '		<div class="form-check form-check-inline">';
						innerHtml += '			<input class="form-check-input" type="radio" name="radioGroup'+v.CLAUSE_DETAIL_SEQ_NO+'" id="radio'+v.CLAUSE_DETAIL_SEQ_NO+'_1" value="Y" checked> <label class="form-check-label pointer" for="radio'+v.CLAUSE_DETAIL_SEQ_NO+'_1">동의</label>';
						innerHtml += '		</div>';
						innerHtml += '		<div class="form-check form-check-inline">';
						innerHtml += '			<input class="form-check-input" type="radio" name="radioGroup'+v.CLAUSE_DETAIL_SEQ_NO+'" id="radio'+v.CLAUSE_DETAIL_SEQ_NO+'_2" value="N"> <label class="form-check-label pointer" for="radio'+v.CLAUSE_DETAIL_SEQ_NO+'_2">동의하지 않음</label>';
						innerHtml += '		</div>';
						innerHtml += '	</div>';
						innerHtml += '</section>';
					} else if(gfn_str_parseNull(v.CLAUSE_KIND_GCD) == "0002") {
						innerHtml += '<section class="sec-3 mb-5" >';
						innerHtml += '	<ul class="list list-style-1"><li>위 내용을 확인 하였으며 선택 항목에 대해 동의 합니다.</li></ul>';
						innerHtml += '	<div class="text-center">';
						
						$.each((v.CLAUSE_ITEM_NMS).split("|"), function(_idx, _obj) { 
                            if(_idx < 3) {
                                $.each((_obj).split("^"), function(__idx, __obj) { 
                                    if(gfn_str_parseNull(__obj) != "") {
                                        innerHtml += '	<div class="custom-control custom-checkbox custom-control-inline '+((_idx == 0)?"K":(_idx == 1)?"E":"C")+'" style="' + ((_idx > 0)?"display:none;":"") + '">';
                						innerHtml += '		<input type="checkbox" class="custom-control-input" id="'+ v.SYSTEM_GCD+v.CLAUSE_SEQ_NO+v.CLAUSE_DETAIL_SEQ_NO+((_idx == 0)?"K":(_idx == 1)?"E":"C")+"_CHK" +((v.CLAUSE_ITEM_NMS).split("|")[3]).split("^")[__idx] +'" idx="'+((v.CLAUSE_ITEM_NMS).split("|")[3]).split("^")[__idx]+'"> <label class="custom-control-label pointer" for="'+ v.SYSTEM_GCD+v.CLAUSE_SEQ_NO+v.CLAUSE_DETAIL_SEQ_NO+((_idx == 0)?"K":(_idx == 1)?"E":"C")+"_CHK" +((v.CLAUSE_ITEM_NMS).split("|")[3]).split("^")[__idx] +'">'+__obj+'</label>';
                						innerHtml += '	</div>';
                                    }
                                });
                            }
                        });						
						innerHtml += '	</div>';
						innerHtml += '</section>';
					}
					$("#clausePopups .sec-2 .sec-body").append(innerHtml);
					$("#clausePopups .sec-2 .sec-body .accordion:eq("+i+")").data(v);					
					$("#clausePopups .sec-2 .sec-body .card-body .nav-item").click(function(){
						if($(this).closest(".accordion").data().CLAUSE_KIND_GCD == "0002") {
							$(this).closest(".accordion").next().find(".custom-checkbox").hide();
							$(this).closest(".accordion").next().find(".custom-control-input").prop('checked',false);
							$(this).closest(".accordion").next().find("." + $(this).find("a").attr("lang")).show();
						}
					});					
				});
			}
		});
	}
	
	function clauseValidation() {
		var validationResult = true;
		$.each($("#clausePopups .sec-2 .sec-body .accordion"), function(idx, obj) {
            var _obj = $(obj).data();
            if(_obj.CLAUSE_KIND_GCD == "0001" && _obj.ESSENTIAL_FG == 'Y' && $(this).next().find("input:radio:checked").val() == "N") {
                alert('['+_obj.CLAUSE_DETAIL_NM + ']는 필수동의 항목 입니다.');
                validationResult = false;
                return false;
            }
            if(_obj.CLAUSE_KIND_GCD == "0002" && _obj.ESSENTIAL_FG == 'Y' && $(this).next().find("input:checkbox:checked").length == 0) {
            	alert('['+_obj.CLAUSE_DETAIL_NM + ']는 필수동의 항목 입니다. 1개 이상 선택 해주세요.');
                validationResult = false;
                return false;
            }
        });
		return validationResult;
	}

	function fn_clauseConfirm() {
		
		if(clauseValidation()) {
			var agreeDlt = [];
            var _obj = {};
            $.each($("#clausePopups .sec-2 .sec-body .accordion"), function(idx, obj) {
                _obj = $(obj).data();
                if(_obj.CLAUSE_KIND_GCD == "0001") {
                    _obj.AGREE_FG = $(this).next().find("input:radio:checked").val();
                } else {
                    _obj.AGREE_FG = (($(this).next().find("input:checkbox:checked").length > 0) ? "Y":"N");                                
                    $.each($(this).next().find("input:checkbox:checked"), function(_idx, chks) {
                        _obj.MULTI_ITEM_CHOICE_VALUE = gfn_str_parseNull(_obj.MULTI_ITEM_CHOICE_VALUE) + ((_idx > 0) ? ',' : '') + $(chks).attr("idx");
                    });
                }
                _obj.USER_ID = scwin.loginUser.userId;
                _obj.INS_USER_IP = scwin.loginUser.userIp;
                _obj.INS_SYSTEM_GCD = scwin.menuInfo.SYSTEM_GCD;
                _obj.INS_MENU_CD = scwin.menuInfo.MENU_CD;
                agreeDlt.push(_obj);
            });
            //gfn_com_closeModalWall($(".accordion:eq(0)"));
            gfn_com_closeModalWall(1,function(){
    	            if(typeof scwin.clause._options.callbackFunc == "function"){
    					scwin.clause._options.callbackFunc(agreeDlt);   
    				}else if (typeof scwin.clause._options.callbackFunc == "string"){
    				    window[scwin.clause._options.callbackFunc](agreeDlt);
    				}
    	            objTarget.focus();
			});
			
		}
	}
</script>