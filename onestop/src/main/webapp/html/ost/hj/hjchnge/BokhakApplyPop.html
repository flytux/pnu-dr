<div id="popups">
	<section class="sec-1">
		<div class="sec-body">
			<div class="b-table-box flex-col-3" id="stdtTable" role="table" aria-label="학적정보 테이블">
				<div class="b-row-box" role="row">
					<div class="b-row-item merge-3">
						<div class="b-title-box" role="rowheader">
							<label data-lang>소속(과정)</label>
						</div>
						<div class="b-con-box" role="cell">
							<span data-bind="text: DEPT_NM"></span>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label data-lang>학번(성명)</label>
						</div>
						<div class="b-con-box" role="cell">
							<span data-bind="text: STDT_INFO"></span>
							<input type="hidden" id="STDT_NO" data-bind="value: STDT_NO" />
						</div>
					</div>
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label id="lbl_STDT_YEAR_NM" data-lang>학년</label>
						</div>
						<div class="b-con-box" role="cell">
							<span data-bind="text: STDT_YEAR_NM"></span>
						</div>
					</div>
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label data-lang>학적상태</label>
						</div>
						<div class="b-con-box" role="cell">
							<span data-bind="text: HJ_STA_NM"></span>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item merge-prev">
						<div class="b-title-box" role="rowheader">
							<label data-lang>누적휴학학기수</label>
						</div>
						<div class="b-con-box" role="cell">
							<span data-bind="text: HYUHAK_ACC_CNT"></span>
						</div>
					</div>
					<div class="b-row-item merge-2">
						<div class="b-title-box" role="rowheader">
							<label data-lang>휴학가능학기수</label>
						</div>
						<div class="b-con-box" role="cell">
							<span data-bind="text: HYUHAK_CNT"></span>
						</div>
					</div>
				</div>
			</div>
			<div class="b-table-box flex-col-2" id="stdtTable" role="table" aria-label="변경사항 테이블">
				<div class="b-row-box" role="row">
					<div class="b-row-item merge-2">
						<div class="b-title-box" role="rowheader">
							<label class="req" data-lang>신청학년도/학기</label>
						</div>
						<div class="b-con-box" role="cell">
							<span data-bind="text: APPLY_SYEAR_TERM"></span>
							<input type="hidden" id="APPLY_SYEAR" data-bind="value: APPLY_SYEAR" />
							<input type="hidden" id="APPLY_TERM_GCD" data-bind="value: APPLY_TERM_GCD" />
							<input type="hidden" id="CHG_SEQ_NO" data-bind="value: CHG_SEQ_NO" />
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label class="req" data-lang>복학사유</label>
						</div>
						<div class="b-con-box" role="cell">
							<div class="form-check form-check-inline">
								<input class="form-check-input" type="radio" name="CHG_APPLY_REASON_GCD" id="radio1" value="0015" data-bind="checked: CHG_APPLY_REASON_GCD"
									checked>
								<label class="form-check-label mr-2" for="radio1" data-lang>일반복학</label>
								<input class="form-check-input" type="radio" name="CHG_APPLY_REASON_GCD" id="radio2" value="0016" data-bind="checked: CHG_APPLY_REASON_GCD">
								<label class="form-check-label mr-2" for="radio2" data-lang>병역복학</label>
							</div>
						</div>
					</div>
					<div class="b-row-item">
						<div class="b-con-box text-primary align-items-center" role="cell">
							<span class="info-text" data-lang> 그 외 복학사유는 학과 사무실 방문 신청</span>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item merge-2">
						<div class="b-title-box" role="rowheader">
							<label data-lang>휴학기간</label>
						</div>
						<div class="b-con-box" role="cell" aria-colspan="3">
							<div class="row">
								<div class="col-xl-12">
									<span id="startSyear" data-bind="text: HYUHAK_START_SYEAR"></span>학년도 &nbsp;<span id="startTermNm" data-bind="text: HYUHAK_START_TERM_NM"></span>부터
									<input type="hidden" id="SUPPOSE_SYEAR" data-bind="value: HYUHAK_START_SYEAR" />
									<input type="hidden" id="SUPPOSE_TERM_GCD" data-bind="value: HYUHAK_START_TERM_GCD" />
								</div>
								<div class="col-xl-12">
									<span id="endSyear" data-bind="text: HYUHAK_END_SYEAR"></span>학년도 &nbsp;<span id="endTermNm" data-bind="text: HYUHAK_END_TERM_NM"></span>까지
									<input type="hidden" id="hyuhakEndSyear" data-bind="value: HYUHAK_END_SYEAR" />
									<input type="hidden" id="hyuhakEndTermGcd" data-bind="value: HYUHAK_END_TERM_GCD" />
								</div>
								<div class="col-xl-4">
									<span>(</span><span id="HYUHAK_TERM_CNT" data-bind="text: HYUHAK_TERM_CNT"></span><span>학기간)</span>
								</div>
							</div>

						</div>
					</div>
				</div>
				<div class="b-row-box" role="row" id="milRow">
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label class="req" for="MIL_END_DATE" data-lang>전역일자</label>
						</div>
						<div class="b-con-box" role="cell">
							<div class="row">
								<div class="col-8">
									<input type="text" id="MIL_END_DATE" class="form-control datepicker" data-bind="value: MIL_END_DATE_FORMAT" />
								</div>
							</div>
						</div>
					</div>
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label class="req" for="MIL_NO" data-lang>군번</label>
						</div>
						<div class="b-con-box" role="cell">
							<div class="row">
								<div class="col-12">
									<input type="text" id="MIL_NO" class="form-control numeric" data-bind="value: MIL_NO" />
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item merge-2">
						<div class="b-title-box" role="rowheader">
							<label class="req" for="STDT_ZIP_NO" data-lang>주소</label>
						</div>
						<div class="b-con-box" role="cell">
							<div class="row">
								<div class="col-xl-2">
									<input type="text" class="form-control" id="STDT_ZIP_NO" data-bind="value: STDT_ZIP_NO" readonly="readonly" />
								</div>
								<div class="col-auto ml-1">
									<button class="btn btn-primary" onclick="fn_jusoPop()" type="button">우편번호 검색</button>
								</div>
								<div class="col-xl-12">
									<input type="text" class="form-control" id="STDT_ADDR" data-bind="value: STDT_ADDR" title="주소" readonly="readonly" />
								</div>
								<div class="col-xl-12">
									<input type="text" class="form-control" id="STDT_DETAIL_ADDR" data-bind="value: STDT_DETAIL_ADDR" title="상세주소"/>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item merge-2">
						<div class="b-title-box" role="rowheader">
							<label class="req" for="STDT_EMAIL" data-lang>이메일</label>
						</div>
						<div class="b-con-box" role="cell">
							<div class="row">
								<div class="col-xl-12">
									<input type="text" class="form-control" id="STDT_EMAIL" data-bind="value: STDT_EMAIL" />
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label class="req" for="STDT_CELLULAR_NO" data-lang>본인 휴대폰</label>
						</div>
						<div class="b-con-box" role="cell">
							<div class="row">
								<div class="col-xl-12">
									<input type="text" class="form-control" id="STDT_CELLULAR_NO" data-bind="value: CELLULAR_NO" />
								</div>
							</div>
						</div>
					</div>
					<div class="b-row-item">
						<div class="b-con-box text-primary text-right" role="cell">
							<span class="info-text" data-lang>입력하신 휴대폰번호로 신청처리결과를 안내드리니 정확히 입력하시기 바랍니다.</span>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item merge-2">
						<div class="b-title-box" role="rowheader">
							<label for="STDT_TEL_NO" data-lang>본인 전화번호</label>
						</div>
						<div class="b-con-box" role="cell">
							<div class="row">
								<div class="col-xl-12">
									<input type="text" class="form-control" id="STDT_TEL_NO" data-bind="value: CELLULAR_NO" />
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row" id="fileRow">
					<div class="b-row-item merge-2">
						<div class="b-title-box" role="rowheader">
							<label class="req">첨부파일</label>
						</div>
						<div class="b-con-box" role="cell">
							<div class="sec-body" id="uploader_target1"></div>
							<input type="hidden" id="ATTACH_FILE_GRP_CD" data-bind="value: ATTACH_FILE_GRP_CD" />
						</div>
					</div>
				</div>
			</div>
			<header class="mt-5">
				<h4 class="sec-title text-center mb-5">위와 같이 복학하고자 하오니 허가하여 주시기 바랍니다.</h4>
				<h6 class="sec-title text-center mt-5">
					<span data-bind="text: APPLY_YEAR"></span>년 <span data-bind="text: APPLY_MONTH"></span>월 <span data-bind="text: APPLY_DAY"></span>일
				</h6>
				<p class="text-right">
					<span>본 인 : &nbsp;</span><span id="userNm" data-bind="text: STDT_KOR_NM"></span>
				</p>
				<h4 class="sec-title text-left mt-2">부산대학교 총장 귀하</h4>
			</header>
			<div class="_footer">
				<section class="sec-1">
					<div class="sec-body">
						<div class="btn-box">
							<div class="form-row btn-box-right">
								<div class="col-auto">
									<button class="btn btn-primary" id="btnSubmit" type="button" data-lang onclick="javascript:return fn_applySave('S');">제출</button>
									<button class="btn btn-danger" id="btnCancel" type="button" data-lang onclick="javascript:return fn_applySave('C');">신청취소</button>
								</div>
							</div>
						</div>
					</div>
				</section>
			</div>
		</div>
	</section>
</div>
<script type="text/javascript">
	$(document).ready(popInit());
	/* 전역변수 */
	var btnFlag = ""; // 수정버튼 : update, 신청취소버튼 : cancel 

	function popInit() {
		setInit();
		setBindFn();

		$("#STDT_CELLULAR_NO").telEditor({
			txtVal : gfn_str_parseNull(scwin.detailObj.STDT_CELLULAR_NO_TXT),
			originVal : scwin.detailObj.STDT_CELLULAR_NO,
			telnoGbn : "C", /* 휴대폰번호 : C, 전화번호(팩스) : T, ALL : A */
			telnoNm : "휴대폰번호",
			callbackFunc : function(e) {

			},
			dataBound : function(e) {

			}
		});

		$("#STDT_TEL_NO").telEditor({
			txtVal : gfn_str_parseNull(scwin.detailObj.STDT_TEL_NO_TXT),
			originVal : scwin.detailObj.STDT_TEL_NO,
			telnoGbn : "T", /* 휴대폰번호 : C, 전화번호(팩스) : T, ALL : A */
			telnoNm : "휴대폰번호",
			callbackFunc : function(e) {

			},
			dataBound : function(e) {

			}
		});

		$("#STDT_EMAIL").emailEditor({
			val : gfn_str_parseNull(scwin.detailObj.STDT_EMAIL),
			callbackFunc : function(e) {

			},
			dataBound : function(e) {

			}
		});
	}

	/*  팝업창 로드 시 초기설정 함수 */
	function setInit() {
		gfn_com_dataBind($("#popups"), scwin.detailObj, '', function(e) {
			if (scwin.rowState == "C") {
				$("#btnCancel").hide();
			}
			$("input[name=CHG_APPLY_REASON_GCD]").attr("disabled", true); // 휴학사유 
			if ($("input[name=CHG_APPLY_REASON_GCD]:checked").val() == "0015") {
				$("#milRow").hide();
				$("#fileRow").hide();
			} else {
				$("#milRow").show();
				$("#fileRow").show();
			}

			// 대학일 때는 학년, 대학원일 때는 학기
			if (scwin.loginUser.collGradGcd == "0001") {
				$("#lbl_STDT_YEAR_NM").html("학년");
			} else {
				$("#lbl_STDT_YEAR_NM").html("학기");
			}
		});
	}

	/* 이벤트 바인딩 함수 */
	function setBindFn() {
		// 휴학사유 변경 시 이벤트
		$("input[name=CHG_APPLY_REASON_GCD]").change(function() {
			var chgApplyReasonGcd = $(this).val();
			// 일반복학 선택 시
			if (chgApplyReasonGcd == "0015") {
				$("#milRow").hide();
				$("#fileRow").hide();
			} else {
				$("#milRow").show();
				$("#fileRow").show();
			}
		});
	}

	function fn_jusoPop() {
		gfn_com_openJusoPop({
			callbackFunc : function(e) {
				$("#STDT_ZIP_NO").val(e.zipCd);
				$("#STDT_ADDR").val(e.addr);
				$("#STDT_DETAIL_ADDR").val("").focus();
			}
		});
	}

	/* 필수입력 체크 */
	function fn_validate(param) {
		var rtnValue = true;
		var valObj = [];
		// 병역복학일 때 병역관련 사항 필수체크
		if ($("input:radio[name=CHG_APPLY_REASON_GCD]:checked").val() == "0016") {
			valObj.push({
				"id" : "MIL_END_DATE",
				"name" : "전역일자",
				"notNull" : true,
			}, {
				"id" : "MIL_NO",
				"name" : "군번",
				"notNull" : true,
			});

		}
		valObj.push({
			"id" : "STDT_ZIP_NO",
			"name" : "우편번호",
			"notNull" : true,
		}, {
			"id" : "STDT_ADDR",
			"name" : "주소",
			"notNull" : true,
		}, {
			"id" : "STDT_DETAIL_ADDR",
			"name" : "상세주소",
			"notNull" : true,
		}, {
			"id" : "STDT_EMAIL",
			"name" : "이메일",
			"notNull" : true,
		}, {
			"id" : "STDT_CELLULAR_NO",
			"name" : "본인휴대폰",
			"notNull" : true,
		});

		rtnValue = gfn_val_validateDataMap(param, valObj);

		if (!rtnValue)
			return rtnValue;

		return rtnValue;
	}

	/* 기타 유효성 체크 */
	function fn_validateEtc() {
		if ($("input:radio[name=CHG_APPLY_REASON_GCD]:checked").val() == "0016") {
			if ($("#uploader_target1").find(".attach-list li").length < 1) {
				alert("첨부파일은 필수 입력 사항 입니다.");
				return;
			}
		}
		return true;
	}

	/* 저장 함수 */
	function fn_applySave(type) {
		if ($("input:radio[name=CHG_APPLY_REASON_GCD]:checked").val() == "0016") {
			$("#ATTACH_FILE_GRP_CD").val($("#uploader_target1").find("#file_1").attr('attach_file_grp_cd'));
		}

		var confirmMsg = gva_SAVE_CONFIRM_MSG;
		var param = gfn_com_inputdata($("#popups"));

		if (!fn_validate(param))
			return false;

		if (!fn_validateEtc())
			return false;

		// 제출, 신청취소 버튼 클릭에 따른 처리
		if (scwin.rowState == "U") {
			if (type == "S") {
				btnFlag = "update";
			} else {
				btnFlag = "cancel";
				confirmMsg = "신청 취소하시겠습니까?";
			}
		}

		confirm(confirmMsg, function(_flag) {
			if (_flag) {
				// 수정 :  rowState = "U", 신청취소 : rowState = "D"
				if (btnFlag == "update") {
					param["rowState"] = "U";
				} else if (btnFlag == "cancel") {
					param["rowState"] = "D";
				} else {
					param["rowState"] = scwin.rowState;
				}
				param["MIL_END_DATE"] = param.MIL_END_DATE.replace(/-/gi, "");
				
				/* 신청취소 일 때는 복학가능 여부 체크 안함 */
				if(type == "S") {
					fn_selectBokhakPossibleYn(param);
				}else {
					fn_applySaveCallback(param); 
				}
				
			}
		});
	}

	/* 복학가능여부 조회 */
	function fn_selectBokhakPossibleYn(param) {

		/* ajax처리 */
		gfn_ajax_request({
			url : "/ost/hj/hjchnge/bokhakApply/selectBokhakPosibleYn",
			reqData : param,
			success : function(data, responseData) {
				if (data.O_RSLT == "N") {
					alert(data.O_MSG);
					return;
				} else {
					fn_applySaveCallback(param);
				}
			}
		});
	}
	
	/* 복학신청 저장 */
	function fn_applySaveCallback(param) {

		param["userAgent"] = navigator.userAgent;
		
		gfn_ajax_request({
			url : "/ost/hj/hjchnge/bokhakApply/executeBokhakApply",
			reqData : param,
			success : function(data, responseData) {
				alert(data.O_MSG);
				// 신청 완료
				if (data.O_RSLT == "Y") {
					var attach_file_grp_cd = $("#ATTACH_FILE_GRP_CD").val();
					fn_fileComplete(attach_file_grp_cd);
					gfn_com_closeModalWall(1, function() {
						fn_sch();
					});
				}
			}
		});
	}	

	/* 파일업로드 컴포넌트 */
	var uploader_target1 = $("#uploader_target1").formuploader({
		SYSTEM_GCD : "0001", //시스템코드
		ATTACH_FILE_GCD : "0002", // 첨부파일 종류 코드 
		ATTACH_FILE_GRP_CD : $("#ATTACH_FILE_GRP_CD").val(), // 첨부파일 그룹 코드 
		ACCEPT_EXT : "GIF, JPG, PNG, JPEG", // 허용확장자 ( 메뉴설정에서 들고 오거나 지정한 확장자가 없으면 기본 확장자로 사용. )
		UPLOAD_SIZE : "4",
		FILE_ADD_YN : "Y", //신규추가가능여부
		FILE_DEL_YN : "Y", //삭제가능여부
		FILE_DWN_YN : "Y", //다운로드가능여부
		FILE_INFO_YN : "Y", /* 확장자와 제한용량 정보표시 여부*/
		FILE_AREA_WIDTH_PER : 100, /* 첨부파일영역의 %값 */
		FILE_COMMENT : "첨부가능문서 : 병역사항이기재된 초본, 전역예정증명서, 병적증명서, 전역증 사본, 군전역일자조회물 출력(병무청홈페이지) <br/> 4MB 이하의 그림파일(gif, jpg, png, jpeg)만 업로드가 가능합니다. ",
		FILE_VIEWER_YN : "Y", /* 첨부파일뷰어 표시 여부 */
		dataBound : function(e,_target) { /* 업로드 완료후 처리 함수*/
			$("#ATTACH_FILE_GRP_CD").val($("#uploader_target1").find("#file_1").attr('attach_file_grp_cd'));
			alert("업로드 완료", _target);
		}

	});
</script>