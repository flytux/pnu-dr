<div id="popups">
	<section class="sec-1">
		<div class="sec-body">
			<section class="sec-3 mb-3">
				<header>
					<h4 class="sec-title">수강신청 교과목내역</h4>
				</header>
				<div class="sec-body">
					<div class="table-box">
						<div class="table-body">
							<table class="table table-hover">
								<caption>수강신청 교과목내역</caption>
								<colgroup>
									<col style="min-width: 70px;">
									<col style="min-width: 200px;">
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
									<col style="min-width: 200px;">
									<col style="min-width: 250px;">
								</colgroup>
								<thead>
									<tr>
										<th scope="col">No</th>
										<th scope="col">교과목명</th>
										<th scope="col">교과목번호</th>
										<th scope="col">분반</th>
										<th scope="col">담당교수</th>
										<th scope="col">강의시간</th>
									</tr>
								</thead>
								<tbody id="applySubjTbody"></tbody>
							</table>
						</div>
					</div>
				</div>
			</section>
			<section class="sec-3 mb-4">
				<header>
					<h4 class="sec-title">출결사항</h4>
				</header>
				<div class="sec-body">
					<div class="table-box">
						<div class="table-body">
							<table class="table table-hover">
								<caption>출결사항</caption>
								<colgroup>
									<col style="min-width: 70px;">
									<col style="min-width: 120px;">
									<col style="min-width: 80px;">
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
									<col style="min-width: 100px;">
								</colgroup>
								<thead>
									<tr>
										<th scope="col">No</th>
										<th scope="col">강의일자</th>
										<th scope="col">요일</th>
										<th scope="col">교시</th>
										<th scope="col">시작시간</th>
										<th scope="col">종료시간</th>
										<th scope="col">강의구분</th>
										<th scope="col">출결사항</th>
										<th scope="col">이의신청</th>
									</tr>
								</thead>
								<tbody id="attendTbody"></tbody>
							</table>
						</div>
					</div>
				</div>
			</section>
			<section class="sec-3">
				<div class="sec-body">
					<div class="b-table-box flex-col-3" id="stdtInfoTable" role="table" aria-label="사유 테이블">
						<div class="b-row-box" role="row">
							<div class="b-row-item merge-3">
								<div class="b-title-box" role="rowheader">
									<label class="req" for="APPLY_REASON_GCD" data-lang>사유</label>
								</div>
								<div class="b-con-box" role="cell">
									<select id="APPLY_REASON_GCD" class="form-control">
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
			<div class="_footer">
				<section class="sec-1">
					<div class="sec-body">
						<div class="btn-box">
							<div class="form-row btn-box-right">
								<div class="col-auto">
									<button class="btn btn-danger" id="btnApply" type="button" data-lang onclick="javascript:return fn_applySave();">이의신청</button>
								</div>
							</div>
						</div>
					</div>
				</section>
			</div>
		</div>
	</section>
</div>
<script type="text/x-tbody-template" id="applySubjTemplate">
	<tr style="cursor:pointer;">
		<td>#:RN#</td>
        <td>#:SUBJ_NM#</td>
	    <td>#:SUBJ_NO#</td>
		<td>#:CLASS_NO#</td>
		<td>#:PROF_NM#</td>
		<td>#:TIMETABLE_SUMMARY_INFO#</td>
	</tr>
</script>
<script type="text/x-tbody-template" id="attendTemplate">
	<tr style="cursor:pointer;">
		<td>#:RN#</td>
        <td>#:LECT_DATE_FORMAT#</td>
		<td>#:DAY_GCD_NM#</td>
	    <td>#:START_LECTTIME#</td>
		<td>#:START_TIME#</td>
		<td>#:CLOSE_TIME#</td>
		<td>#:LECT_GCD_NM#</td>
		<td>#:ATTEND_GCD_NM#</td>
		<td># if( :ATTEND_GCD== "") {# <input type="checkbox" disabled>#}
				  else {# <input type="checkbox" name="attendChk" title="#:LECT_DATE_FORMAT#">#}
		</td>
	</tr>
</script>
<script type="text/javascript">
	$(document).ready(popInit());

	function popInit() {

		gfn_com_DropDownLists([ {
			elements : $("#APPLY_REASON_GCD"),
			commonCode : "0001_APPLY_REASON_GCD",
			dataTextField : "COMMON_DETAIL_CD_KOR_NM",
			dataValueField : "COMMON_DETAIL_CD",
			defaultValue : "",
			expnCondition : "AND COMMON_DETAIL_CD != '0012'" ,  /*백신접속 사용안함*/
			hakbuGradFg : false,
			dataBound : function(e) {
			}
		} ]);
		fn_applySubjSch();
	}

	/* 수강신청 교과목 내역 조회 */
	function fn_applySubjSch(data) {

		/* 검색조건데이터 가져오기 */
		if (gfn_com_isEmptyObject(data)) {
			data = gfn_com_searchData($(".search-box"));
		}

		/* ajax처리 */
		gfn_ajax_request({
			url : "/ost/cls/attendconf/attendConfDissentApply/selectListApplySubj",
			reqData : data,
			success : function(data, responseData) {
				$("#applySubjTbody").listView({
					dataSource : data,
					emptyComment : '교과목내역이 존재하지 않습니다.',
					dataBound : function(e) {
						$("#applySubjTbody tr").find("td").bind("click", function(e) {
							scwin.popDetailObj = $(this).closest("tr").data();
							fn_attendSch();
						});
						totalCnt = responseData.pageInfo.totCnt;
						currentData = data;
					},
					template : $("#applySubjTemplate"),
					totalCnt : responseData.totalCnt,
					paging : {
						pageInfo : responseData.pageInfo,
						reqData : responseData.reqData,
						func : "fn_applySubjSch"
					},
				});

				if (!gfn_com_isEmptyObject(data)) {
					// 첫번째 row데이터로 출결사항 조회
					scwin.popDetailObj = $("#applySubjTbody tr:eq(0)").data();
					$("#applySubjTbody tr:eq(0)").find("td").addClass("active");

					fn_attendSch();
				} else {
					$("#attendTbody").html("<td colspan='9' class='text-center'>해당 교과목의 출결사항이 존재하지 않습니다.</td>");
				}
			}
		});
	}

	/* 출결사항 목록 조회 */
	function fn_attendSch(data) {
		/* 검색조건데이터 가져오기 */
		if (gfn_com_isEmptyObject(data)) {
			data = gfn_com_searchData($(".search-box"));
			data["SUBJ_NO"] = scwin.popDetailObj.SUBJ_NO;
			data["CLASS_NO"] = scwin.popDetailObj.CLASS_NO;
		}

		/* ajax처리 */
		gfn_ajax_request({
			url : "/ost/cls/attendconf/attendConfDissentApply/selectListAttend",
			reqData : data,
			success : function(data, responseData) {

				$("#attendTbody").listView({
					dataSource : data,
					emptyComment : '해당 교과목의 출결사항이 존재하지 않습니다.',
					dataBound : function(e) {
						totalCnt = responseData.pageInfo.totCnt;
						currentData = data;
					},
					template : $("#attendTemplate"),
					totalCnt : responseData.totalCnt,
					paging : {
						pageInfo : responseData.pageInfo,
						reqData : responseData.reqData,
						func : "fn_attendSch"
					},
				});
			}
		});
	}

	/* 이의신청 함수 */
	function fn_applySave() {

		if (gfn_str_parseNull($("#APPLY_REASON_GCD").val()) == "") {
			alert("사유를 선택하지 않으셨습니다.", $("#APPLY_REASON_GCD"));
			return;
		}

		if ($("input[name='attendChk']:checked").length <= 0) {
			alert("이의신청 할 출결사항을 선택하지 않으셨습니다.");
			return;
		}

		confirm("이의신청을 하시겠습니까?", function(_flag) {
			if (_flag) {
				// 체크된 행 List로 구현
				var paramList = [];

				for (var i = 0; i < $("input[name='attendChk']:checked").closest('tr').length; i++) {
					var paramObj = $("input[name='attendChk']:checked").closest('tr').eq(i).data();

					paramObj["SYEAR"] = $("#SCH_SYEAR").val();
					paramObj["TERM_GCD"] = $("#SCH_TERM_GCD").val();
					paramObj["APPLY_REASON_GCD"] = $("#APPLY_REASON_GCD").val();

					paramList.push(paramObj);
				}
				/* ajax처리 */
				gfn_ajax_request({
					url : "/ost/cls/attendconf/attendConfDissentApply/insertDissentApply",
					reqData : paramList,
					success : function(data, responseData) {
						alert(data.O_MSG);
						// 신청 완료
						if (data.O_RSLT == "Y") {
							gfn_com_closeModalWall(1, function() {
								fn_sch();
							});
						}
					}
				});
			}
		});
	}
</script>