<div id="popups">
	<section class="sec-1">
		<div class="sec-body">

			<!-- 테이블 리스트 - 헤더 고정 -->
				<div class="table-box ">
					<div class="table-body">
						<table class="table table-hover" data-toggle="table" data-show-column="true">
							<caption>교과목정보</caption>
							<colgroup>
								<col style="min-width: 30px;">
								<col style="min-width: 100px;">
								<col style="min-width: 30px;">
								<col style="min-width: 100px;">
								<col style="min-width: 30px;">
							</colgroup>
							<thead>
								<tr>
									<th scope="col">교과목번호</th>
									<th scope="col">교과목명</th>
									<th scope="col">분반</th>
									<th scope="col">담당교수</th>
									<th scope="col">신청</th>
								</tr>
							</thead>
							<tbody id="resultTbody">
							</tbody>
						</table>
					</div>
				</div>
			<!-- /END 테이블 -->
			
			<div class="b-table-box flex-col-1" id="stdtTable" role="table" aria-label="변경사항 테이블">
				<div class="b-row-box" role="row">
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label for="ATTEND_START_DATE" data-lang>기간</label>
						</div>
						<div class="b-con-box" role="cell">
							<div><span data-bind="text: SCH_SYEAR"></span>학년도 <span data-bind="text: SCH_TERM_GCD_NM"></span> 기간 : </div>&nbsp;
							<div>
								<input type="text" id="ATTEND_START_DATE" title="신청시작일" name="siteCheckEnymd" class="form-control datepicker" />
							</div>
							&nbsp;~&nbsp;
							<div>
								<input type="text" id="ATTEND_CLOSE_DATE" title="신청종료일" name="siteCheckEnymd" class="form-control datepicker" />
							</div>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item">
						<div class="b-title-box" role="rowheader">
							<label for="APPLY_REASON_GCD" data-lang>사유</label>
						</div>
						<div class="b-con-box" role="cell">
							<select id="APPLY_REASON_GCD" class="form-control col-4" onchange="fn_applyReasonGcd();"></select>
						</div>
					</div>
				</div>
				<div class="b-row-box" role="row" id="wrapDetailReasonContent">
							<div class="b-row-item merge-3">
								<div class="b-title-box" role="rowheader">
									<label class="req" for="DETAIL_REASON_CONTENT" data-lang>상세사유내용</label>
								</div>
								<div class="b-con-box" role="cell">
									<div class="input-group">
										<textarea class="form-control" id="DETAIL_REASON_CONTENT"></textarea>
									</div>
								</div>
							</div>
						</div>
				<div class="b-row-box" role="row">
					<div class="b-row-item merge-2">
						<div class="b-title-box" role="rowheader">
							<label>첨부파일</label>
						</div>
						<div class="b-con-box" role="cell">
							<div id="download_target"></div>
							<div class="sec-body" id="uploader_target1"></div>
							<input type="hidden" id="ATTACH_FILE_GRP_CD" data-bind="value: ATTACH_FILE_GRP_CD" />
						</div>
					</div>
				</div>
			</div>
			
			<header class="mt-5">
				<h4 class="sec-title text-center mb-5">위와 같은 출석인정원을 제출하오니 허가하여 주시기 바랍니다.</h4>
				<h6 class="sec-title text-center mt-5">
					<span data-bind="text: YEAR"></span>년 <span data-bind="text: MONTH"></span>월 <span data-bind="text: DATE"></span>일
				</h6>
				<h4 class="sec-title text-center mt-2"><span data-bind="text: COLLNAME"></span>(원)장 귀하</h4>
			</header>									
			
			<div class="btn-box mb-4">
				<div class="form-row btn-box-right">
					<div class="col-auto">
						<button class="btn btn-primary" id="btnSubmit" type="button" data-lang onclick="javascript:return fn_save();">등록</button>
					</div>
					<div class="col-auto">
						<button class="btn btn-outline-dark" id="btnClose" type="button" data-lang onclick="javascript:gfn_com_closeModalWall();">닫기</button>
					</div>
				</div>
			</div>
		</div>
	</section>
</div>

<script type="text/x-tbody-template" id="resultTemplate">
	<tr class="multiple-choice#:RN#" style="cursor:pointer;">
        <td>#:SUBJ_NO #</td>
	    <td>#:SUBJ_NM#</td>
	    <td>#:CLASS_NO #</td>
	    <td>#:PROF_NM#</td>
	    <td>
			<input type="checkbox" data-lang class="APPLY_CHK" id="APPLY_CHK" value="1" title="#:SUBJ_NM#"></input>
			<input type="hidden" id="STDT_NO" value="#:STDT_NO#"></input>
			<input type="hidden" id="SYEAR" value="#:SYEAR#"></input>
			<input type="hidden" id="TERM_GCD" value="#:TERM_GCD#"></input>
			<input type="hidden" id="SUBJ_NO" value="#:SUBJ_NO#"></input>
			<input type="hidden" id="CLASS_NO" value="#:CLASS_NO#"></input>

			<input type="hidden" id="ATTEND_START_DATE_VAL"  value=""></input>
			<input type="hidden" id="ATTEND_CLOSE_DATE_VAL"  value=""></input>
			<input type="hidden" id="APPLY_REASON_GCD_VAL"  value=""></input>
			<input type="hidden" id="DETAIL_REASON_CONTENT_VAL"  value=""></input>
		</td>
	</tr>
</script>

<script type="text/javascript">
	var total = 0; // 전체 문항수
	var questionNo = new Array();
	$(document).ready(popInit());

	function popInit() {
		setInit();
	}
	
	/***************************************************************************
	 * 팝업창 로드 시 초기설정 함수
	 **************************************************************************/	
	function setInit() {
		//페이지 로딩시 상세사유입력 컴포넌트 숨김처리
		$("#wrapDetailReasonContent").hide();
		gfn_com_dataBind($("#popups"), scwin.detailObj);
		
		fn_schPop();
		
		gfn_com_DropDownLists([{          
			elements : $("#APPLY_REASON_GCD"),
            commonCode : "0001_APPLY_REASON_GCD",
            dataTextField : "COMMON_DETAIL_CD_KOR_NM",
            dataValueField : "COMMON_DETAIL_CD",
            optionLabel : "선택",
            optionValue : "",
            defaultValue : "", 
            expnCondition : "AND COMMON_DETAIL_CD != '0012'" ,  /*백신접속 사용안함*/
            hakbuGradFg : false,
            dataBound : function(e) {
            }
        }]);
		
		var nowDay = new Date();
		var today = nowDay.toISOString().slice(0, 10);
		
		$("#ATTEND_START_DATE").val(today);
		$("#ATTEND_CLOSE_DATE").val(today);
	}
	
	/***************************************************************************
	 * 신청내역조회
	 **************************************************************************/
	 function fn_schPop() {		
			/* 검색조건데이터 가져오기 */
			data = scwin.detailObj;
			/* ajax처리 */
			gfn_ajax_request({
				url : "/ost/cls/attendconf/attendacceptapply/selectLecApply",
				reqData : data,
				success : function(data, responseData) {
					total = responseData.totalCnt;
	            	
					var len = JSON.stringify(data.length);
					for (var i = 0; i < len; i++) {
						if(data[i].RN != "") {
							var no = data[i].RN;
							questionNo.push(no);''
						}
					}                
					
					$("#resultTbody").listView({
							
		            	dataSource : data,
		            	emptyComment : "조회내역이 없습니다.",
		                dataBound : function(e) {	  
	                		totalCnt = responseData.pageInfo.totCnt;
		                    currentData = data;	 
		            	},
						template : $("#resultTemplate"),
							totalCnt : responseData.totalCnt,
							totalViewYn : "N" ,
					});		
					
				}
			}); 	
		}	
	
	/***************************************************************************
	 * 입력 필수 조건 확인
	 **************************************************************************/
	function fn_popValidate() {
		var rtnValue = true;
		var valObj = [ ];
		
		valObj =[{
			"id" : "APPLY_CHK",
			"name" : "교과목",
			"notNull" : true
		}, {	
			"id" : "ATTEND_START_DATE",
			"name" : "기간 시작일자",
			"notNull" : true
		}, {
			"id" : "ATTEND_CLOSE_DATE",
			"name" : "기간 종료일자",
			"notNull" : true
		}, {
			"id" : "APPLY_REASON_GCD",
			"name" : "사유",
			"notNull" : true
		}];
		
		rtnValue = gfn_val_validateDataMap(param, valObj);
		if (!rtnValue){
			return rtnValue;
		}
		
		return rtnValue;	
	}
	
	/***************************************************************************
	 * 기타 유효성 체크
	 **************************************************************************/	
	function fn_validateEtc() {
/* 		if ($("#uploader_target1").find(".attach-list li").length < 1) {
			alert("첨부파일을 등록해주세요.");
			return;
		} */
		return true;
	}	
	
	var param = [];
	var confirmMsg = "";	
	/***************************************************************************
	 * [저장]
	 **************************************************************************/
	function fn_save() {
		confirmMsg = gva_SAVE_CONFIRM_MSG;
		
		$("#ATTACH_FILE_GRP_CD").val($("#uploader_target1").find("#file_1").attr('attach_file_grp_cd'));

		param = gfn_com_inputdata($("#popups"));
		
		// 필수입력 조건 확인
		if (!fn_popValidate(data)){
			return false;
		}
		if($("#ATTEND_START_DATE").val() > $("#ATTEND_CLOSE_DATE").val()){
			alert("종료일자보다 시작일자가 클 수 없습니다.")
			return;
		}
		
		if (gfn_str_parseNull($("#APPLY_REASON_GCD").val()) == "0012") {
			if (gfn_str_parseNull($("#DETAIL_REASON_CONTENT").val()) == "") {
				alert("상세사유내용을 입력하지 않으셨습니다.", $("#DETAIL_REASON_CONTENT"));
				return;
			}	
		}
		
		// 첨부파일 필수입력 확인
		if (!fn_validateEtc()){
			return false;
		}

		fn_clause(data);
	}			
	
	/***************************************************************************
	 * 개인정보동의
	 **************************************************************************/	
	function fn_clause(param) {
		gfn_com_clausePop({
			title : '정보동의팝업',
			systemGcd : '0002',
			clauseSeqNo : 4,
			callbackFunc : function(data){
				/* 필수동의 사항에 동의한 경우 콜백 실행 */
				param["agreeDltInfo"] = data;
				
				gfn_ajax_request({
					url : "/ost/cls/attendconf/attendacceptapply/saveClause",
					reqData : param,
					success : function(data, responseData) {
						fn_applySaveCallback();// 저장함수 넣기
					}
				});
				
				
			}
		});
	}

	/***************************************************************************
	 * 저장 콜백 함수
	 **************************************************************************/		
	function fn_applySaveCallback() {

			/* ajax처리 */
			confirm(
					"체크한 항목을 신청하시겠습니까?",
					function(_flag) {
						if (_flag) {
							// list
							var data = new Array();
							var data_index = 0;
							for (var i = 0; i<questionNo.length; i++) {
								var map = gfn_com_inputdata($(".multiple-choice"+questionNo[i]));
								
								// if 체크한 행만 push
								if(map.APPLY_CHK == "1"){
									data.push(map);
									data[data_index].ATTACH_FILE_GRP_CD = $("#ATTACH_FILE_GRP_CD").val();
									data[data_index].ATTEND_START_DATE_VAL = $("#ATTEND_START_DATE").val();
									data[data_index].ATTEND_CLOSE_DATE_VAL = $("#ATTEND_CLOSE_DATE").val();
									data[data_index].APPLY_REASON_GCD_VAL = $("#APPLY_REASON_GCD").val();
									data[data_index].DETAIL_REASON_CONTENT_VAL = $("#DETAIL_REASON_CONTENT").val();
									
									
									data_index++;
									// 개인정보동의
// 									var lastIndex = data.length;
// 									data[lastIndex] = agreeDltInfo;
									//data["agreeDltInfo"] = agreeDltInfo;
								}
							}
							// /END list
							gfn_ajax_request({
								url : "/ost/cls/attendconf/attendacceptapply/saveLecApply",
								reqData : data,
								success : function(data, responseData) {
									alert("출석인정신청 되었습니다. 승인이 완료되면 출석인정허가서를 출력하여 교과목 담당교원에게 제출하여 주시기 바랍니다.",$("#apply_btn"));
									var attach_file_grp_cd = $("#ATTACH_FILE_GRP_CD").val();
		 							gfn_com_closeModalWall(1,function(){
		 								
	 									fn_sch();
	 								});
		 							
								}
							});
						}
					})
				
					
				
	}

	/***************************************************************************
	 * 파일업로드 컴포넌트
	 **************************************************************************/		
	var uploader_target1 = $("#uploader_target1").formuploader({
		SYSTEM_GCD : "0002", //시스템코드
		ATTACH_FILE_GCD : "0002", // 첨부파일 종류 코드 
		ATTACH_FILE_GRP_CD : $("#ATTACH_FILE_GRP_CD").val(), // 첨부파일 그룹 코드 
		ACCEPT_EXT : "GIF, JPG, PNG, JPEG, PDF", // 허용확장자 ( 메뉴설정에서 들고 오거나 지정한 확장자가 없으면 기본 확장자로 사용. )
		UPLOAD_SIZE : "4",
		FILE_ADD_YN : "Y", //신규추가가능여부
		FILE_DEL_YN : "Y", //삭제가능여부
		FILE_DWN_YN : "Y", //다운로드가능여부
		FILE_INFO_YN : "Y", /* 확장자와 제한용량 정보표시 여부*/
		FILE_AREA_WIDTH_PER : 100, /* 첨부파일영역의 %값 */
		FILE_COMMENT : "",
		FILE_VIEWER_YN : "Y", /* 첨부파일뷰어 표시 여부 */
		dataBound : function(e,_target) { /* 업로드 완료후 처리 함수*/
			alert("업로드 완료",_target);
			$("#ATTACH_FILE_GRP_CD").val($("#uploader_target1").find("#file_1").attr('attach_file_grp_cd'));
		}

	});

	/***************************************************************************
	 * 상세사유내용 컴포넌트 제어 함수
	 **************************************************************************/
	function fn_applyReasonGcd(){
		if (gfn_str_parseNull($("#APPLY_REASON_GCD").val()) == "0009") {
			alert("취업으로 인한 출석인정의 경우, 재직여부 재확인을 위해 학기 말(기말고사 실시 전) 소속 학과로 재직증명서 추가 제출이 필요하니 참고하여 주시기 바랍니다.\n 조기취업으로 출석을 인정받은 학생의 성적평가는 B+ 이하로 하오니 참고하여 주시기 바랍니다.")
		} else if (gfn_str_parseNull($("#APPLY_REASON_GCD").val()) == "0012") {
			$("#wrapDetailReasonContent").show();
		} else{
			$("#wrapDetailReasonContent").hide();		
		}
	}

</script>